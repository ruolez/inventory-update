{% extends "base.html" %}

{% block title %}History - Inventory Update{% endblock %}

{% block content %}
<div class="history-container">
    <div class="flex-between mb-md">
        <h1 class="page-title">Transaction History</h1>
        <button id="refresh-btn" class="btn btn-secondary btn-sm">Refresh</button>
    </div>

    <!-- Filters -->
    <div class="card">
        <div class="flex-between" style="flex-wrap: wrap; gap: var(--spacing-md);">
            <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 150px;">
                <label class="form-label" for="status-filter">Status</label>
                <select id="status-filter" class="form-input">
                    <option value="">All</option>
                    <option value="success">Success</option>
                    <option value="failed">Failed</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 150px;">
                <label class="form-label" for="username-filter">Username</label>
                <input type="text" id="username-filter" class="form-input" placeholder="Filter by username">
            </div>
            <div class="form-group" style="margin-bottom: 0; min-width: 100px;">
                <label class="form-label" for="page-size">Per page</label>
                <select id="page-size" class="form-input">
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Transactions table -->
    <div class="card">
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>User</th>
                        <th>Product</th>
                        <th>Old Qty</th>
                        <th>Entered</th>
                        <th>+ Quotes</th>
                        <th>+ Bins</th>
                        <th>+ POs</th>
                        <th>Final</th>
                        <th>Diff</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="transactions-body">
                    <!-- Transactions will be loaded here -->
                </tbody>
            </table>
        </div>

        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
        </div>

        <div id="no-transactions" class="empty-state hidden">
            <div class="empty-state-icon">ðŸ“‹</div>
            <p>No transactions found.</p>
        </div>

        <!-- Pagination -->
        <div id="pagination" class="pagination hidden">
            <div class="pagination-info">
                Showing <span id="showing-start">0</span>-<span id="showing-end">0</span> of <span id="total-count">0</span>
            </div>
            <div class="pagination-controls">
                <button id="prev-btn" class="btn btn-secondary btn-sm" disabled>Previous</button>
                <span id="page-indicator" class="page-indicator">Page 1 of 1</span>
                <button id="next-btn" class="btn btn-secondary btn-sm" disabled>Next</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPage = 1;
let totalPages = 1;
let pageSize = 25;

document.addEventListener('DOMContentLoaded', () => {
    loadTransactions();

    document.getElementById('refresh-btn').addEventListener('click', () => { currentPage = 1; loadTransactions(); });
    document.getElementById('status-filter').addEventListener('change', () => { currentPage = 1; loadTransactions(); });
    document.getElementById('username-filter').addEventListener('input', debounce(() => { currentPage = 1; loadTransactions(); }, 300));
    document.getElementById('page-size').addEventListener('change', (e) => {
        pageSize = parseInt(e.target.value);
        currentPage = 1;
        loadTransactions();
    });
    document.getElementById('prev-btn').addEventListener('click', () => {
        if (currentPage > 1) { currentPage--; loadTransactions(); }
    });
    document.getElementById('next-btn').addEventListener('click', () => {
        if (currentPage < totalPages) { currentPage++; loadTransactions(); }
    });
});

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

async function loadTransactions() {
    const loading = document.getElementById('loading');
    const tbody = document.getElementById('transactions-body');
    const noTransactions = document.getElementById('no-transactions');
    const pagination = document.getElementById('pagination');

    loading.classList.remove('hidden');
    tbody.innerHTML = '';
    noTransactions.classList.add('hidden');
    pagination.classList.add('hidden');

    const status = document.getElementById('status-filter').value;
    const username = document.getElementById('username-filter').value.trim();
    const offset = (currentPage - 1) * pageSize;

    let url = `/api/transactions?limit=${pageSize}&offset=${offset}`;
    if (status) url += `&status=${encodeURIComponent(status)}`;
    if (username) url += `&username=${encodeURIComponent(username)}`;

    try {
        const data = await api(url);
        loading.classList.add('hidden');

        if (data.transactions.length === 0) {
            noTransactions.classList.remove('hidden');
            return;
        }

        tbody.innerHTML = data.transactions.map(tx => `
            <tr>
                <td>${formatDate(tx.created_at)}</td>
                <td>${tx.username}</td>
                <td title="${tx.product_upc}">${tx.product_description || tx.product_upc || '-'}</td>
                <td>${tx.old_quantity ?? '-'}</td>
                <td>${tx.user_entered_qty ?? '-'}</td>
                <td class="${tx.quotations_qty > 0 ? 'text-success' : ''}">${tx.quotations_qty ?? '-'}</td>
                <td class="${tx.top_bins_qty > 0 ? 'text-success' : ''}">${tx.top_bins_qty ?? '-'}</td>
                <td class="text-secondary">${tx.purchase_orders_qty ?? '-'}</td>
                <td><strong>${tx.new_quantity}</strong></td>
                <td class="${tx.difference > 0 ? 'text-success' : tx.difference < 0 ? 'text-error' : ''}">
                    ${tx.difference !== null ? (tx.difference > 0 ? '+' : '') + tx.difference : '-'}
                </td>
                <td>
                    <span class="badge ${tx.status === 'success' ? 'badge-success' : 'badge-error'}">
                        ${tx.status}
                    </span>
                </td>
            </tr>
        `).join('');

        // Update pagination
        const total = data.total;
        totalPages = Math.ceil(total / pageSize);
        const start = offset + 1;
        const end = Math.min(offset + data.transactions.length, total);

        document.getElementById('showing-start').textContent = start;
        document.getElementById('showing-end').textContent = end;
        document.getElementById('total-count').textContent = total.toLocaleString();
        document.getElementById('page-indicator').textContent = `Page ${currentPage} of ${totalPages}`;

        document.getElementById('prev-btn').disabled = currentPage <= 1;
        document.getElementById('next-btn').disabled = currentPage >= totalPages;

        pagination.classList.remove('hidden');
    } catch (error) {
        loading.classList.add('hidden');
        showToast('Failed to load transactions', 'error');
    }
}

function formatDate(isoString) {
    if (!isoString) return '-';
    const date = new Date(isoString);
    return date.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
    });
}
</script>
{% endblock %}
